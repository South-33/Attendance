rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Sessions: Creation and discovery
    match /sessions/{sessionId} {
      // Allow finding sessions by code (used in StudentView)
      allow read: if resource == null || resource.data.active == true;
      
      // Allow creation with valid schema
      allow create: if request.resource.data.keys().hasAll(['teacherId', 'passcode', 'active', 'createdAt']);
      
      // Allow updates only if the teacherId matches (pseudo-auth)
      allow update: if request.resource.data.teacherId == resource.data.teacherId;
      
      // Prevent deletion for audit trail (deactivation only)
      allow delete: if false;
    }

    // Queue: Real-time interactions
    match /queue/{queueId} {
      // Students and Teachers can interact with the queue
      allow read, create: if true;
      
      // Limit updates to prevent cross-session manipulation
      allow update: if request.resource.data.sessionId == resource.data.sessionId;
      
      // Allow cleanup
      allow delete: if true;
    }
  }
}
